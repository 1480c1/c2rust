From 4e9688f287b5a14705e8f2a4d347443b564b0e01 Mon Sep 17 00:00:00 2001
From: Eric Mertens <emertens@galois.com>
Date: Tue, 13 Feb 2018 16:39:21 -0800
Subject: [PATCH] Add initial automation script

---
 process.sh     | 41 +++++++++++++++++++++++++++++++++++++++++
 setup.py       |  2 +-
 snudownrust.rs |  4 ++++
 3 files changed, 46 insertions(+), 1 deletion(-)
 create mode 100755 process.sh
 create mode 100644 snudownrust.rs

diff --git a/process.sh b/process.sh
new file mode 100755
index 0000000..523a355
--- /dev/null
+++ b/process.sh
@@ -0,0 +1,41 @@
+AST_EXTRACTOR=/Users/emertens/clang-llvm/xcode-build/Debug/bin/ast-extractor
+AST_IMPORTER=/Users/emertens/Source/c2rust/c2rust/ast-importer/target/debug/ast_importer
+LIB_PATH=/Users/emertens/.rustup/toolchains/nightly-2017-11-20-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib
+RUSTFMT=rustfmt
+
+OUTPUT_DIR=translator-build
+
+translate() {
+  $AST_EXTRACTOR src/$1.c
+  RUST_BACKTRACE=1 DYLD_LIBRARY_PATH=$LIB_PATH $AST_IMPORTER --reloop-cfgs src/$1.c.cbor > $OUTPUT_DIR/$1.rs
+  $RUSTFMT $OUTPUT_DIR/$1.rs
+  rustc --crate-type=rlib --crate-name=$1 $OUTPUT_DIR/$1.rs -o $OUTPUT_DIR/lib$1.rlib
+}
+
+compile_commands_entry() {
+
+        cat >> compile_commands.json <<END
+{
+  "directory": "${PWD}",
+  "command": "cc -o ${OUTPUT_DIR}/${1}.c.o -c ${PWD}/src/${1}.c -Wwrite-strings -D_FORTIFY_SOURCE=0 -DNDEBUG=1",
+  "file": "${PWD}/src/${1}.c"
+},
+END
+
+}
+
+echo "[" > compile_commands.json
+compile_commands_entry "autolink"
+compile_commands_entry "buffer"
+compile_commands_entry "stack"
+compile_commands_entry "markdown"
+echo "]" >> compile_commands.json
+
+mkdir $OUTPUT_DIR
+
+translate "autolink"
+translate "buffer"
+translate "stack"
+translate "markdown"
+
+rustc --crate-name=snudownrust --crate-type=staticlib -L $OUTPUT_DIR snudownrust.rs -o $OUTPUT_DIR/libsnudownrust.a
diff --git a/setup.py b/setup.py
index baa2e22..964835f 100644
--- a/setup.py
+++ b/setup.py
@@ -49,7 +49,7 @@ setup(
             sources=['snudown.c', 'src/bufprintf.c'] + c_files_in('html/'),
             include_dirs=['src', 'html'],
             libraries=['lib'],
-            library_dirs=['src/build']
+            library_dirs=['translator-build']
         )
     ],
 )
diff --git a/snudownrust.rs b/snudownrust.rs
new file mode 100644
index 0000000..2c456a5
--- /dev/null
+++ b/snudownrust.rs
@@ -0,0 +1,4 @@
+extern crate autolink;
+extern crate buffer;
+extern crate markdown;
+extern crate stack;
-- 
2.16.1

